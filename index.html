<html>

<head>
	<script type="text/javascript" src="jquery.js"></script>
	<style>
		* {
			margin: 0px;
			padding: 0px;
		}

		:root {
			--transition: all 0.25s ease-out;
		}

		@keyframes rotate-360 {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
		}


		body {
			position: fixed;
			top: 0px;
			left: 0px;
			right: 0px;
			bottom: 0px;
			background: #000;
			height: 100%;
		}

		.bg {
			--x: 0px;
			--y: 0px;
			--x-change-rate: 0.02;
			--y-change-rate: 0.02;
			position: absolute;
			top: calc(var(--x-change-rate) * -1 * 100%);
			left: calc(var(--y-change-rate) * -1 * 100%);
			width: calc((1 + var(--x-change-rate)) * 100%);
			height: calc((1 + var(--y-change-rate)) * 100%);
			margin: 0px;
			z-index: -9999;
			background-image: url('kv_bg.jpg');
			background-size: cover;
			background-repeat: no-repeat;
			background-position: var(--x) var(--y);
			transition: var(--transition);
		}

		.kv {
			--x: 0px;
			--y: 0px;
			--x-change-rate: 0.04;
			--y-change-rate: 0.06;
			--x-change-resist: calc(var(--x-change-rate) * 100% * -1.0);
			--y-change-resist: calc(var(--y-change-rate) * 100% * -1.0);
			height: 100%;
			width: 100%;
			z-index: 899;
			position: absolute;
			bottom: calc(var(--y) * -1 + var(--y-change-resist));
			right: calc(var(--x) * -1 + var(--x-change-resist));
			height: calc((var(--y-change-rate) + 1) * 100%);
			background-size: contain;
			background-repeat: no-repeat;
			background-position: bottom right;
			transition: var(--transition);
			transform: scale(0.95);
			transform-origin: right bottom;
		}

		.kv.kv_chara_01 {
			background-image: url('kv_chara_01.png');
		}

		.kv.kv_chara_02 {
			background-image: url('kv_chara_02.png');
		}

		.kv.kv_chara_03 {
			background-image: url('kv_chara_03.png');
		}

		.kv_flare {
			--degree: 0deg;
			--degree-change-rate: 0.06;
			position: absolute;
			z-index: 999;
			height: 100%;
			width: 100%;
			top: 0px;
			right: 0%;
			background-image: url('kv_flare.png');
			background-size: contain;
			background-repeat: no-repeat;
			background-position: top right;
			mix-blend-mode: screen;
			opacity: 0.7;
			transform: scale(1.0);
			transform-origin: top right;
		}

		.dust {
			z-index: -99;
			position: absolute;
			left: 100%;
			top: 0px;
			background-size: cover;
			background-repeat: no-repeat;
			background-position: top center;
			transform: scale(0.65);
			opacity: 0.6;
		}

		.dust.bg_dust_01 {
			background-image: url('bg_dust_01.png');
			width: 160px;
			height: 117px;
		}

		.dust.bg_dust_02 {
			background-image: url('bg_dust_02.png');
			width: 134px;
			height: 117px;
		}

		.dust.bg_dust_03 {
			background-image: url('bg_dust_03.png');
			width: 131px;
			height: 128px;
		}

		.dust.bg_dust_04 {
			background-image: url('bg_dust_04.png');
			width: 168px;
			height: 136px;
		}

		.logo {
			--display: none;
			--opacity: 0.8;
			display: var(--display);
			z-index: 1999;
			position: absolute;
			right: 40px;
			top: 25px;
			height: 20%;
			width: 10%;
			max-height: 352px;
			max-width: 580px;
			background-image: url('logo.png');
			background-size: contain;
			background-repeat: no-repeat;
			background-position: top right;
			opacity: var(--opacity);
			transition: opacity 0.7s ease 0.3s;
			pointer-events: none;
		}

		.console {
			--display: none;
			position: fixed;
			right: 0;
			top: 0;
			width: 500px;
			height: auto;
			text-align: left;
			font-family: 'Consolas', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			z-index: 9999;
			color: #e6e6e6;
			font-size: 1.4rem;
			padding-left: 0.4rem;
			background: rgba(0, 0, 0, 0.5);
			display: var(--display);
			white-space: nowrap;
			pointer-events: none;
		}

		.console * {
			list-style-type: none;
		}

		.bg_canvas{
			position: absolute;
			top: 0px;
			left: 0px;
			height: 100%;
			width: 100%;
			z-index: 1799 !important;
		}

		.bg_circle{
			position: absolute;
			background-image: url("bg_circle_news.png");
			background-position: center center;
			background-repeat: no-repeat;
			background-size: contain;
			width: 704px;
    		height: 704px;
			margin-left: -352px;
			animation: rotate-360 200s linear 0.2s infinite;
			left: 50%;
		}

	</style>
</head>

<body>
	<div class="bg"></div>
	<div class="kv kv_chara_01"></div>
	<div class="kv kv_chara_02"></div>
	<div class="kv kv_chara_03"></div>
	<div class="kv_flare"></div>
	<div class="logo"></div>
	<canvas class="bg_canvas" id="bg_canvas"></canvas>

	<div class="console">
		<ul>
			<ul id="bg">
				<li id="bg"></li>
			</ul>
			<ul id="kv">
				<li id="01"></li>
				<li id="02"></li>
				<li id="03"></li>
			</ul>
			<ul id="flare">
				<li id="flare"></li>
			</ul>
			<ul id="dust"></ul>
		</ul>
	</div>

	<script>

		var global_instandRatio = 0.025;
		var global_outstandRatio = 1.8;
		var global_degreeRatio = 1;

		$('body').mousemove(mouse);

		window.wallpaperPropertyListener = {
			applyUserProperties: function (properties) {

				// Quality
				if (properties.movement_performance) {
					if (properties.movement_performance.value) {
						switch (properties.movement_performance.value) {
							case 'high': // All on
								global_instandRatio = 0.025;
								global_outstandRatio = 1.8;
								global_degreeRatio = 1;
								$('.kv').css('transition', 'var(--transition)');
								$('.bg').css('transition', 'var(--transition)');
								$('body').unbind();
								$('body').mousemove(mouse);
								break;
							case 'simple': // Remove transition .3s ease and in/outstand
								global_instandRatio = global_outstandRatio = 1;
								global_degreeRatio = 0;
								$('.kv').css('transition', 'none');
								$('.bg').css('transition', 'none');
								$('body').mousemove(mouse);
								break;
							case 'none': // All static
								global_instandRatio = global_outstandRatio = 0;
								global_degreeRatio = 0;
								$('.kv').css('transition', 'none');
								$('.bg').css('transition', 'none');
								$('body').unbind();
								break;
						}
					}
				}


				// Mahouka Logo
				if (properties.mahouka_logo) {
					if (properties.mahouka_logo.value) {
						$('.logo').css('--display', 'block');
					}else{
						$('.logo').css('--display', 'none');
					}
				}

				// Mahouka Logo Opacity
				if (properties.mahouka_logo_opacity) {
					if (properties.mahouka_logo_opacity.value) {
						$('.logo').css('--opacity', properties.mahouka_logo_opacity.value / 10);
					}
				}


				// Character Amplitude X
				if (properties.character_amplitude_x) {
					if (properties.character_amplitude_x.value) {
						$('.kv').css('--x-change-rate', properties.character_amplitude_x.value / 100);
					}
				}

				// Character Amplitude Y
				if (properties.character_amplitude_y) {
					if (properties.character_amplitude_y.value) {
						$('.kv').css('--y-change-rate', properties.character_amplitude_y.value / 100);
					}
				}

				// Background Amplitude
				if (properties.background_amplitude) {
					if (properties.background_amplitude.value) {
						$('.bg').css('--x-change-rate', properties.background_amplitude.value / 100);
						$('.bg').css('--y-change-rate', properties.background_amplitude.value / 100);
					}
				}

				// Particles
				if (properties.particles) {
					if (properties.particles.value) {
						var script = '<script type="text/javascript" src="createjs.js"><\/script><script type="text/javascript" src="particlejs.js"><\/script><script type="text/javascript" src="particle.js"><\/script>';
						$('.particles-script').html(script);
					}else{
						$('.particles-script').html("<br>");
					}
				}

				// Flare Amplitude
				if (properties.flare_amplitude) {
					if (properties.flare_amplitude.value) {
						$('.fv_flare').css('--degree-change-rate', properties.flare_amplitude.value / 100);
					}
				}

				// Console
				if (properties.developer_console) {
					if (properties.developer_console.value) {
						$('.console').css('--display', 'block');
					}else{
						$('.console').css('--display', 'none');
					}
				}

				mouse();

			}
		}

		setInterval(function () {

			let rand = Math.floor(Math.random() * 10000 + 1000);
			let top = Math.random() * 1000;
			let dust = '';
			let id = (Date.now()).valueOf() + rand;
			if (rand % 5 == 0) {
				dust = '<div class="dust dust bg_dust_01" id="' + id + '"></div>';
				top *= -1
			} else if (rand % 5 == 1) {
				dust = '<div class="dust dust bg_dust_02" id="' + id + '"></div>';
				top *= -1
			} else if (rand % 5 == 2) {
				dust = '<div class="dust dust bg_dust_03" id="' + id + '"></div>';
			} else if (rand % 5 == 3) {
				dust = '<div class="dust dust bg_dust_04" id="' + id + '"></div>';
			} else {
				return;
			}

			time = Math.min(Math.max(rand, 3000), 7000);
			$('body').append(dust);
			$('#' + id).css({ 'top': top + 'px' });
			$('.console #dust').append("<li id='console-" + id + "'>dust_" + id + ": " + top + "px</li>");

			$('#' + id).animate({ 'margin-top': '50%', 'left': '-100px' }, time, 'linear', function () {
				$('#console-' + id).remove();
				$(this).remove();
			});


		}, 1500);

		function mouse(e) {

			let width = $('body').width();
			let height = $('body').height();

			let wr = e.screenX / width;
			let hr = e.screenY / height;

			let kv_xChangeRate = $('.kv').css('--x-change-rate') * 1.0;
			let kv_yChangeRate = $('.kv').css('--y-change-rate') * 1.0;

			let kv_xChangeRate_instand = kv_xChangeRate * global_instandRatio;
			let kv_xChangeRate_outstand = kv_xChangeRate * global_outstandRatio;
			let kv_tolerancePixel = 3; // Unit: px

			$('.kv').css({ '--x': (e.offsetX * kv_xChangeRate * -1.0 + kv_tolerancePixel) + 'px', '--y': (e.offsetY * kv_yChangeRate * -1.0 + kv_tolerancePixel) + 'px' });

			if (wr < 0.3) {
				$('.kv_chara_02').css({ '--x': e.offsetX * kv_xChangeRate_instand * -1 + 'px' });
				$('.kv_chara_03').css({ '--x': e.offsetX * kv_xChangeRate_instand * -1 + 'px' });
			} else if (wr < 0.6) {
				$('.kv_chara_01').css({ '--x': e.offsetX * kv_xChangeRate_outstand * -1 + 'px' });
				$('.kv_chara_03').css({ '--x': e.offsetX * kv_xChangeRate_instand * -1 + 'px' });
			} else {
				$('.kv_chara_01').css({ '--x': e.offsetX * kv_xChangeRate_outstand * -1 + 'px' });
				$('.kv_chara_02').css({ '--x': e.offsetX * kv_xChangeRate_outstand * -1 + 'px' });
			}

			$('.console #kv #01').html("kv_01: " + $('.kv_chara_01').css('--x') + ", " + $('.kv_chara_01').css('--y'));
			$('.console #kv #02').html("kv_02: " + $('.kv_chara_02').css('--x') + ", " + $('.kv_chara_02').css('--y'));
			$('.console #kv #03').html("kv_03: " + $('.kv_chara_03').css('--x') + ", " + $('.kv_chara_03').css('--y'));

			let bg_xChangeRate = $('.bg').css('--x-change-rate');
			let bg_yChangeRate = $('.bg').css('--y-change-rate');

			$('.bg').css({ '--x': e.offsetX * bg_xChangeRate + 'px', '--y': e.offsetY * bg_yChangeRate + 'px' });
			$('.console #bg #bg').html("bg: " + $('.bg').css('--x') + ", " + $('.bg').css('--y'));

			let flare_degreeChangeRate = $('.kv_flare').css('--degree-change-rate') * global_degreeRatio;
			let flare_degree = Math.atan2(e.offsetY, width - e.offsetX) * (180 / Math.PI) * flare_degreeChangeRate;
			$('.kv_flare').css('--degree', flare_degree + 'deg');
			$('.console #flare #flare').html("flare: " + flare_degree);

		}

	</script>

	<!--- Particles -->
	<div class="particles-script"></div>

</body>

</html>