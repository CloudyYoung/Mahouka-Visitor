<html>

<head>
	<link
		href="https://fonts.googleapis.com/css?family=Noto+Serif+JP:200,300,400,500,600,700,900&display=swap&subset=japanese"
		rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:400,700&display=swap" rel="stylesheet">
	<link
		href="https://fonts.loli.net/css?family=Noto+Serif+JP:200,300,400,500,600,700,900&display=swap&subset=japanese"
		rel="stylesheet">
	<link href="https://fonts.loli.net/css?family=Roboto+Condensed:400,700&display=swap" rel="stylesheet">
	<script type="text/javascript" src="jquery.js"></script>
	<style>
		body {
			font-family: 'Noto Serif JP';
		}

		* {
			margin: 0px;
			padding: 0px;
		}

		:root {
			--transition: all 0.25s ease-out;
		}

		@keyframes rotate-360 {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		body {
			position: fixed;
			top: 0px;
			left: 0px;
			right: 0px;
			bottom: 0px;
			background: #000;
			height: 100%;
		}

		.bg {
			--x: 0px;
			--y: 0px;
			--x-change-rate: 0.02;
			--y-change-rate: 0.02;
			position: absolute;
			top: calc(var(--x-change-rate) * -1 * 100%);
			left: calc(var(--y-change-rate) * -1 * 100%);
			width: calc((1 + var(--x-change-rate)) * 100%);
			height: calc((1 + var(--y-change-rate)) * 100%);
			margin: 0px;
			z-index: -9999;
			background-image: url('kv_bg.jpg');
			background-size: cover;
			background-repeat: no-repeat;
			background-position: var(--x) var(--y);
			transition: var(--transition);
		}

		.kv {
			--x: 0px;
			--y: 0px;
			--x-change-rate: 0.04;
			--y-change-rate: 0.06;
			--x-change-resist: calc(var(--x-change-rate) * 100% * -1.0);
			--y-change-resist: calc(var(--y-change-rate) * 100% * -1.0);
			--stand-cancellation: 0px;
			height: 100%;
			width: 100%;
			z-index: 899;
			position: absolute;
			bottom: calc(var(--y) * -1 + var(--y-change-resist));
			right: calc(var(--x) * -1 + var(--x-change-resist));
			width: calc((var(--x-change-rate) + 1) * 100%);
			height: calc((var(--y-change-rate) + 1) * 100%);
			background-size: contain;
			background-repeat: no-repeat;
			background-position: bottom right;
			transition: var(--transition);
			transform: scale(0.95) translateX(var(--stand-cancellation));
			transform-origin: bottom right;
		}

		.kv.kv_chara_01 {
			background-image: url('kv_chara_01.png');
		}

		.kv.kv_chara_02 {
			background-image: url('kv_chara_02.png');
		}

		.kv.kv_chara_03 {
			background-image: url('kv_chara_03.png');
		}

		.kv_flare {
			--degree: 0deg;
			--degree-change-rate: 0.06;
			position: absolute;
			z-index: 999;
			height: 100%;
			width: 100%;
			top: 0px;
			right: 0%;
			background-image: url('kv_flare.png');
			background-size: contain;
			background-repeat: no-repeat;
			background-position: top right;
			mix-blend-mode: screen;
			opacity: 0.7;
			transform: scale(1.0) rotate(var(--degree));
			transform-origin: top right;
		}

		.dust {
			z-index: -99;
			position: absolute;
			left: 100%;
			top: 0px;
			background-size: cover;
			background-repeat: no-repeat;
			background-position: top center;
			transform: scale(0.65);
			opacity: 0.6;
			animation: dust-run 10s linear;
		}

		.dust.bg_dust_01 {
			background-image: url('bg_dust_01.png');
			width: 160px;
			height: 117px;
		}

		.dust.bg_dust_02 {
			background-image: url('bg_dust_02.png');
			width: 134px;
			height: 117px;
		}

		.dust.bg_dust_03 {
			background-image: url('bg_dust_03.png');
			width: 131px;
			height: 128px;
		}

		.dust.bg_dust_04 {
			background-image: url('bg_dust_04.png');
			width: 168px;
			height: 136px;
		}

		@keyframes dust-run {
			from {
				margin-top: 0%;
				left: 100%;
			}

			to {
				margin-top: 50%;
				left: -200px;
			}
		}


		.logo {
			--display: none;
			--opacity: 0.8;
			display: var(--display);
			z-index: 1999;
			position: absolute;
			right: 40px;
			top: 25px;
			height: 20%;
			width: 10%;
			max-height: 352px;
			max-width: 580px;
			background-image: url('logo.png');
			background-size: contain;
			background-repeat: no-repeat;
			background-position: top right;
			opacity: var(--opacity);
			transition: opacity 0.7s ease 0.3s;
		}

		.console {
			--display: none;
			position: fixed;
			right: 0;
			top: 0;
			width: 500px;
			height: auto;
			text-align: left;
			font-family: 'Consolas', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			z-index: 9999;
			color: #e6e6e6;
			font-size: 1.4rem;
			padding-left: 0.4rem;
			background: rgba(0, 0, 0, 0.5);
			display: var(--display);
			white-space: nowrap;
		}

		.console * {
			list-style-type: none;
		}

		.bg_canvas {
			position: absolute;
			top: 0px;
			left: 0px;
			height: 100%;
			width: 100%;
			z-index: 1799 !important;
		}

		.bg_circle {
			position: absolute;
			background-image: url("bg_circle_news.png");
			background-position: center center;
			background-repeat: no-repeat;
			background-size: contain;
			width: 704px;
			height: 704px;
			margin-left: -352px;
			animation: rotate-360 200s linear 0.2s infinite;
			left: 50%;
		}

		.iframe {
			display: none;
		}
	</style>
	<style class="special birthday-text-css">
		.birthday-text {
			position: absolute;
			bottom: 10%;
			right: 0px;
			text-align: right;
			padding: 11px 170px 11px 93px;
			background-image: linear-gradient(90deg, rgba(255, 255, 255, 0) 0%, white 10%, white 100%);
			z-index: 1699;
			letter-spacing: normal;
			line-height: 1;
			text-align: left;
			text-overflow: ellipsis;
			white-space: nowrap;
			display: flex;
			height: auto;
			display: none;
			opacity: 0.85;
		}

		.birthday-text .date {
			color: #42BFB2;
			font-family: 'Roboto Condensed';
			line-height: 1;
			margin-right: 8px;
			font-size: 2em;
			font-weight: 600;
		}

		.birthday-text .text {
			font-size: 1.8em;
			font-weight: 800;
			margin-top: -10px;
			margin-right: 6px;
		}

		.birthday-text .charaface {
			background-size: contain;
			background-repeat: no-repeat;
			background-origin: right bottom;
			background-position: right bottom;
			position: absolute;
			right: 0%;
			bottom: 0%;
			height: calc(128px * 0.85);
			width: calc(200px * 0.85);
		}
	</style>
</head>

<body>
	<div class="bg"></div>
	<div class="kv kv_chara_01"></div>
	<div class="kv kv_chara_02"></div>
	<div class="kv kv_chara_03"></div>
	<div class="kv_flare"></div>
	<div class="logo"></div>
	<canvas class="bg_canvas" id="bg_canvas"></canvas>

	<div class="console">
		<ul>
			<ul id="main">
				<li id="screen"></li>
				<li id="mouse"></li>
			</ul>
			<ul id="bg">
				<li id="bg"></li>
			</ul>
			<ul id="kv">
				<li id="01"></li>
				<li id="02"></li>
				<li id="03"></li>
			</ul>
			<ul id="flare">
				<li id="flare"></li>
			</ul>
			<ul id="dust"></ul>
		</ul>
	</div>

	<div class="special birthday"></div>

	<script>

		var global_degreeRatio = 1;
		var global_outstandRatio = [0.1, 0.1, 0.1];
		var kv_x_stand = [0, 0, 0];
		var kv_stand_ratio = [0.4, 0.8, 1.0];

		mouse({ "clientX": 0, "clientY": 0 });



		let lang = window.navigator.languages ? window.navigator.languages[0] : null;
		lang = lang || window.navigator.language || window.navigator.browserLanguage || window.navigator.userLanguage;

		var shortLang = lang;
		if (shortLang.indexOf('-') !== -1)
			shortLang = shortLang.split('-')[0];

		if (shortLang.indexOf('_') !== -1)
			shortLang = shortLang.split('_')[0];

		$(document).on('mousemove', mouse);

		window.wallpaperPropertyListener = {
			applyUserProperties: function (properties) {

				// Quality
				if (properties.movement_performance) {
					if (properties.movement_performance.value) {
						switch (properties.movement_performance.value) {
							case 'high': // All on
								global_outstandRatio = [0.1, 0.1, 0.1];
								global_degreeRatio = 1;
								$('.kv').css('transition', 'var(--transition)');
								$('.bg').css('transition', 'var(--transition)');
								$(document).unbind("mousemove");
								$(document).mousemove(mouse);
								break;
							case 'simple': // Remove transition .3s ease and in/outstand
								global_outstandRatio = [0, 0, 0];
								kv_x_stand = [0, 0, 0];
								global_degreeRatio = 0;
								$('.kv').css('transition', 'none');
								$('.bg').css('transition', 'none');
								$(document).unbind("mousemove");
								$(document).mousemove(mouse);
								break;
							case 'none': // All static
								global_outstandRatio = [0, 0, 0];
								kv_x_stand = [0, 0, 0];
								global_degreeRatio = 0;
								$('.kv').css('transition', 'none');
								$('.bg').css('transition', 'none');
								$(document).unbind("mousemove");
								break;
						}
					}
				}

				// Mahouka Logo
				if (properties.mahouka_logo) {
					if (properties.mahouka_logo.value) {
						$('.logo').css('--display', 'block');
					} else {
						$('.logo').css('--display', 'none');
					}
				}

				// Mahouka Logo Opacity
				if (properties.mahouka_logo_opacity) {
					if (properties.mahouka_logo_opacity.value) {
						$('.logo').css('--opacity', properties.mahouka_logo_opacity.value / 10);
					}
				}

				// Character Amplitude X
				if (properties.character_amplitude_x) {
					if (properties.character_amplitude_x.value) {
						$('.kv').css('--x-change-rate', properties.character_amplitude_x.value / 100);
					}
				}

				// Character Amplitude Y
				if (properties.character_amplitude_y) {
					if (properties.character_amplitude_y.value) {
						$('.kv').css('--y-change-rate', properties.character_amplitude_y.value / 100);
					}
				}

				// Background Amplitude
				if (properties.background_amplitude) {
					if (properties.background_amplitude.value) {
						$('.bg').css('--x-change-rate', properties.background_amplitude.value / 100);
						$('.bg').css('--y-change-rate', properties.background_amplitude.value / 100);
					}
				}

				// Particles
				if (properties.particles) {
					if (properties.particles.value) {
						$('#bg_canvas').show();
					} else {
						$('#bg_canvas').hide();
					}
				}

				// Flare Amplitude
				if (properties.flare_amplitude) {
					if (properties.flare_amplitude.value) {
						$('.fv_flare').css('--degree-change-rate', properties.flare_amplitude.value / 100);
					}
				}

				// Console
				if (properties.developer_console) {
					if (properties.developer_console.value) {
						$('.console').css('--display', 'block');
					} else {
						$('.console').css('--display', 'none');
					}
				}

				mouse();

			}
		}

		setInterval(function () {

			let rand = Math.floor(Math.random() * 10000 + 1000);
			let top = Math.random() * 1000;
			let dust = '';
			let id = (Date.now()).valueOf() + rand;
			if (rand % 5 == 0) {
				dust = '<div class="dust dust bg_dust_01" id="' + id + '"></div>';
				top *= -1
			} else if (rand % 5 == 1) {
				dust = '<div class="dust dust bg_dust_02" id="' + id + '"></div>';
				top *= -1
			} else if (rand % 5 == 2) {
				dust = '<div class="dust dust bg_dust_03" id="' + id + '"></div>';
			} else if (rand % 5 == 3) {
				dust = '<div class="dust dust bg_dust_04" id="' + id + '"></div>';
			} else {
				return;
			}

			time = Math.min(Math.max(rand, 3000), 7000);
			$('body').append(dust);
			$('#' + id).css({ 'top': top + 'px' });


		}, 1500);

		function mouse(e) {

			let width = window.screen.width;
			let height = window.screen.height;

			$('.console #main #screen').html("screen: " + width + "px, " + height + "px");
			$('.console #main #mouse').html("mouse: " + e.clientX + "px, " + e.clientY + "px");

			let wr = e.clientX / width;
			let hr = e.clientY / height;

			let kv_xChangeRate = $('.kv').css('--x-change-rate') * 1.0;
			let kv_yChangeRate = $('.kv').css('--y-change-rate') * 1.0;
			let kv_tolerancePixel = 1; // Unit: px, technically no need anymore

			if (wr <= kv_stand_ratio[0]) {
				let wr_rate = wr;
				kv_x_stand[0] = e.clientX * wr_rate * global_outstandRatio[0] * -1;
				kv_x_stand[1] = 0;
				kv_x_stand[2] = 0;
			} else if (wr <= kv_stand_ratio[1]) {
				let wr_rate = wr - kv_stand_ratio[0];
				kv_x_stand[0] = e.clientX * kv_stand_ratio[0] * global_outstandRatio[0] * -1;
				kv_x_stand[1] = e.clientX * wr_rate * global_outstandRatio[1] * -1;
				kv_x_stand[2] = 0;
			} else if (wr <= kv_stand_ratio[2]) {
				let wr_rate = wr - kv_stand_ratio[1];
				kv_x_stand[0] = e.clientX * kv_stand_ratio[0] * global_outstandRatio[0] * -1;
				kv_x_stand[1] = e.clientX * (kv_stand_ratio[1] - kv_stand_ratio[0]) * global_outstandRatio[1] * -1;
				kv_x_stand[2] = e.clientX * wr_rate * global_outstandRatio[2] * -1;
			}

			let kv_x = e.clientX * kv_xChangeRate * -1 + kv_tolerancePixel;
			let kv_y = e.clientY * kv_yChangeRate * -1 + kv_tolerancePixel;
			let stand_cancellation = width * (kv_stand_ratio[2] - kv_stand_ratio[1]) * 0.1;

			let kv_03_over = $(document).width() - $('.kv_chara_03').width(); // Make sure within screen
			let kv_y_over = $(document).height() - $('.kv').height();

			$('.kv').each(function (index, obj) {
				let kv_x_this = kv_x + kv_x_stand[index] + stand_cancellation;
				let kv_y_this = kv_y;

				if (kv_y_this < kv_y_over) kv_y_this = kv_y_over;
				if (index == 2 && kv_x_this < kv_03_over) kv_x_this = kv_03_over; // Make sure within screen

				$(obj).css({ "--x": kv_x_this + "px", "--y": kv_y_this + "px" });
			});


			$('.console #kv #01').html("kv_01: " + $('.kv_chara_01').css('--x') + ", " + $('.kv_chara_01').css('--y'));
			$('.console #kv #02').html("kv_02: " + $('.kv_chara_02').css('--x') + ", " + $('.kv_chara_02').css('--y'));
			$('.console #kv #03').html("kv_03: " + $('.kv_chara_03').css('--x') + ", " + $('.kv_chara_03').css('--y'));

			let bg_xChangeRate = $('.bg').css('--x-change-rate');
			let bg_yChangeRate = $('.bg').css('--y-change-rate');

			$('.bg').css({ '--x': e.clientX * bg_xChangeRate + 'px', '--y': e.clientY * bg_yChangeRate + 'px' });
			$('.console #bg #bg').html("bg: " + $('.bg').css('--x') + ", " + $('.bg').css('--y'));

			let flare_degreeChangeRate = $('.kv_flare').css('--degree-change-rate') * global_degreeRatio;
			let flare_degree = Math.atan2(e.clientY, width - e.clientX) * (180 / Math.PI) * flare_degreeChangeRate;
			$('.kv_flare').css('--degree', flare_degree + 'deg');
			$('.console #flare #flare').html("flare: " + flare_degree);

		}

	</script>

	<script class="special birthday-text-script">

		var birthdays = [
			{
				key: "miyuki",
				month: 3,
				day: 25,
				name: ["司波 深雪", "司波 深雪", "Miyuki Shiba"]
			},
			{
				key: "tatsuya",
				month: 4,
				day: 24,
				name: ["司波 達也", "司波 达也", "Tatsuya Shiba"]
			},
			{
				key: "mayumi",
				month: 6,
				day: 26,
				name: ["七草 真由美", "七草 真由美", "Mayumi Saegusa"]
			},
			{
				key: "erika",
				month: 8,
				day: 28,
				name: ["千葉 エリカ", "千叶 艾莉卡", "Erika Chiba"]
			},
			{
				key: "leo",
				month: 8,
				day: 1,
				name: ["西城 レオンハルト", "西城 雷欧赫特", "Leonhard Saijo"]
			},
			{
				key: "mikihiko",
				month: 9,
				day: 10,
				name: ["吉田 幹比古", "吉田 干比古", "Mikihiko Yoshida"]
			},
			{
				key: "mizuki",
				month: 9,
				day: 25,
				name: ["柴田 美月", "柴田 美月", "Mizuki Shibata"]
			},
		];

		var months = [
			'January', 'February', 'March', 'April', 'May',
			'June', 'July', 'August', 'September',
			'October', 'November', 'December'
		];

		birthdays.forEach(each => {
			$('.special.birthday').append(`
			<div class="birthday-text ` + each.key + `">
				<div class= "charaface" style="background-image: url('lz_charaface/CharaFace_` + each.key + `.png')" ></div>
				<span class="date" i18n>` + each.month + `月` + each.day + `日 // ` + each.month + `月` + each.day + `日 // ` + months[each.month - 1] + ` ` + each.day + `</span>
				<span class="text" i18n>` + each.name[0].split(" ")[1] + `の誕生日おめでとう！ // ` + each.name[1].split(" ")[1] + `生日快乐！ // Happy ` + each.name[2].split(" ")[0] + ` Day!</span>
			</div >`);
		});

		$('.special.birthday .birthday-text').hide();


		setInterval(function () {
			var today = new Date();
			var month = today.getMonth() + 1;
			var day = today.getDate();

			birthdays.forEach(each => {
				if (each.month == month && each.day == day) {
					$('.special.birthday .birthday-text.' + each.key).fadeIn();
				} else {
					$('.special.birthday .birthday-text.' + each.key).fadeOut();
				}
			});
		}, 1000);
	</script>

	<script class="i18n">
		$(() => {
			$('[i18n]').each(function () {
				$(this).attr('original-text', $(this).text());
				let arr = $(this).html().split("//");
				if (shortLang == 'ja') {
					$(this).html(arr[0].trim());
				} else if (shortLang == "zh") {
					$(this).html(arr[1].trim());
				} else {
					$(this).html(arr[2].trim());
				}
			});
		});
	</script>

	<!-- Particles -->
	<script type="text/javascript" src="createjs.js"></script>
	<script type="text/javascript" src="particlejs.js"></script>
	<script type="text/javascript" src="particle.js"></script>

	<iframe class="iframe" src="https://meonc.studio/mahouka?origin=wallpaper-engine"></iframe>
	<script>
		var refresh = 1000 * 60 * 5;
		setInterval(function () {
			$(".iframe").attr("src", function (index, attr) {
				return attr;
			});
		}, refresh);
	</script>

</body>

</html>